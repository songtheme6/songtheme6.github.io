<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF 查看</title>
  <style>
    :root { --bg:#0b1020; --panel:#121933; --text:#e6e9f5; --border:#223058; --muted:#9aa3c7; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font: 14px/1.4 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { display: flex; gap: 8px; align-items: center; padding: 8px; background: var(--panel); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    .btn { background: #162246; border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn:hover { border-color: #6aa3ff; }
    .sp { flex: 1; color: var(--muted); font-size: 12px; }
    #viewerContainer { height: calc(100% - 50px); overflow: auto; }
    canvas { display: block; margin: 8px auto; background: #000; box-shadow: 0 0 0 1px #000; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-5b2l1H1w0N1FM7m/bY7rXfevAefS50p3W2pHNVwq8VY8k7r2M8kLkq6m8dP6W8G1WJmX5m2iQnTQe0a9m4tF1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Worker
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <header>
    <button class="btn" id="prev">上一页</button>
    <button class="btn" id="next">下一页</button>
    <span class="sp" id="pageInfo">- / -</span>
    <button class="btn" id="zoomOut">缩小</button>
    <button class="btn" id="zoomIn">放大</button>
  </header>
  <div id="viewerContainer"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const file = params.get('file');
    const container = document.getElementById('viewerContainer');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const zoomOutBtn = document.getElementById('zoomOut');
    const zoomInBtn = document.getElementById('zoomIn');

    let pdfDoc = null;
    let currentPage = 1;
    let scale = 1.15;
    let rendering = false;
    let pendingPage = null;

    async function load() {
      if (!file) {
        container.innerHTML = '<p style="padding:12px;color:#9aa3c7">未选择文件。</p>';
        return;
      }
      try {
        const doc = await pdfjsLib.getDocument({ url: file, withCredentials: false }).promise;
        pdfDoc = doc;
        currentPage = 1;
        renderPage(currentPage);
      } catch (e) {
        container.innerHTML = `<p style="padding:12px;color:#ff8080">加载失败：${e.message}</p>`;
      }
    }

    function renderPage(num) {
      rendering = true;
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        container.innerHTML = '';
        container.appendChild(canvas);
        const renderContext = { canvasContext: ctx, viewport };
        page.render(renderContext).promise.then(() => {
          rendering = false;
          pageInfo.textContent = `${num} / ${pdfDoc.numPages}`;
          if (pendingPage !== null) {
            renderPage(pendingPage);
            pendingPage = null;
          }
        });
      });
    }

    function queueRenderPage(num) {
      if (rendering) {
        pendingPage = num; return;
      }
      renderPage(num);
    }

    prevBtn.addEventListener('click', () => {
      if (!pdfDoc) return;
      if (currentPage <= 1) return;
      currentPage--; queueRenderPage(currentPage);
    });
    nextBtn.addEventListener('click', () => {
      if (!pdfDoc) return;
      if (currentPage >= pdfDoc.numPages) return;
      currentPage++; queueRenderPage(currentPage);
    });
    zoomOutBtn.addEventListener('click', () => { if (!pdfDoc) return; scale = Math.max(0.25, scale - 0.1); queueRenderPage(currentPage); });
    zoomInBtn.addEventListener('click', () => { if (!pdfDoc) return; scale = Math.min(5, scale + 0.1); queueRenderPage(currentPage); });

    load();
  </script>
</body>
</html>
