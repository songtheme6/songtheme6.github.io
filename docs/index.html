<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF å›¾ä¹¦é¦†</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --panel-2: #0e1530;
      --text: #e6e9f5;
      --muted: #9aa3c7;
      --primary: #6aa3ff;
      --accent: #7bd389;
      --border: #223058;
      --card: #162246;
      --hover: #1c2b59;
      --danger: #ff7575;
      --warning: #ffcf66;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 14px/1.4 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #0f1733, #0b1020);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { font-size: 16px; margin: 0; letter-spacing: .5px; }
    header .search {
      flex: 1; display: flex; gap: 8px; align-items: center;
      background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px;
    }
    header input[type="search"] {
      flex: 1; background: transparent; border: none; outline: none; color: var(--text);
      font-size: 14px;
    }
    .layout { display: grid; grid-template-columns: 320px 1fr; height: calc(100% - 58px); }
    aside { border-right: 1px solid var(--border); background: var(--panel-2); overflow: auto; }
    main { display: grid; grid-template-rows: auto auto 1fr; }
    
    /* æ‰‹æœºé€‚é… */
    @media (max-width: 768px) {
      .layout { grid-template-columns: 1fr; }
      aside { display: none; }
      header { flex-wrap: wrap; gap: 8px; }
      header .search { order: 2; width: 100%; }
      .filters { flex-wrap: wrap; gap: 6px; }
      .filters .hint { display: none; }
      .cards { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 8px; }
      .card .meta { padding: 6px; }
      .card .name { font-size: 12px; }
      .card .path { font-size: 11px; }
      .card .badges { font-size: 11px; }
      .related { padding: 6px 8px; }
      .rel-items { gap: 6px; }
      .rel-item { padding: 4px 6px; font-size: 12px; }
    }
    
    @media (max-width: 480px) {
      header { padding: 8px 12px; }
      header h1 { font-size: 14px; }
      .cards { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; padding: 6px; }
      .card .thumb { aspect-ratio: 2/3; }
      .filters { padding: 8px; }
      .btn { padding: 4px 8px; font-size: 12px; }
    }

    .filters { display: flex; gap: 8px; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); background: var(--panel-2); flex-wrap: wrap; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { padding: 4px 8px; border-radius: 999px; background: var(--card); border: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text); }
    .chip.active { background: #1f2b55; border-color: var(--primary); }
    .chip span { opacity: .7; margin-left: 4px; font-variant-numeric: tabular-nums; }

    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; padding: 12px; overflow: auto; background: var(--panel-2); border-bottom: 1px solid var(--border); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: .15s ease; position: relative; }
    .card:hover { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(106,163,255,.2) inset; }
    .thumb { aspect-ratio: 3/4; background: #0a0f22; display: grid; place-items: center; color: var(--muted); font-size: 12px; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; background: #000; }
    .meta { padding: 8px; display: grid; gap: 4px; }
    .name { font-size: 13px; line-height: 1.35; word-break: break-word; }
    .path { color: var(--muted); font-size: 12px; }
    .badges { display: flex; gap: 6px; align-items: center; color: var(--muted); font-size: 12px; }
    .fav { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.5); border: 1px solid var(--border); color: #ffd966; border-radius: 999px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .fav.active { background: #33280a; border-color: #ffcf66; }
    .openbtn { position: absolute; top: 6px; left: 6px; background: rgba(0,0,0,.5); border: 1px solid var(--border); color: #a4d0ff; border-radius: 999px; padding: 4px 8px; cursor: pointer; font-size: 12px; }

    .tree { padding: 8px 10px; }
    .tree details { border-radius: 8px; }
    .tree summary { cursor: pointer; padding: 6px 8px; border-radius: 8px; }
    .tree summary:hover { background: var(--hover); }
    .tree a { color: var(--text); text-decoration: none; display: block; padding: 6px 8px; border-radius: 8px; }
    .tree a:hover { background: var(--hover); }


    .toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 5; }
    .btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn:hover { border-color: var(--primary); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .hint { color: var(--muted); margin-left: auto; font-size: 12px; }

    .related { padding: 12px; border-top: 1px solid var(--border); background: #0f1733; color: var(--muted); font-size: 13px; }
    .rel-items { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .rel-item { background: var(--card); border: 1px solid var(--border); padding: 6px 8px; border-radius: 8px; cursor: pointer; transition: .15s ease; }
    .rel-item:hover { border-color: var(--primary); background: var(--hover); }

    /* æ–‡ä»¶ç®¡ç†æ¨¡æ€æ¡† */
    .file-manager { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: center; justify-content: center; z-index: 50; }
    .file-manager .panel { width: min(800px, 90vw); max-height: 80vh; overflow: hidden; border: 1px solid var(--border); border-radius: 12px; background: var(--panel-2); display: grid; grid-template-rows: auto 1fr auto; }
    .file-manager header { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .file-manager .content { overflow: auto; padding: 16px; }
    .file-manager .footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
    
    .file-list { display: grid; gap: 8px; }
    .file-item { display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; }
    .file-item .icon { font-size: 16px; }
    .file-item .name { flex: 1; }
    .file-item .actions { display: flex; gap: 6px; }
    .file-item .actions .btn { padding: 4px 8px; font-size: 12px; }
    
    .upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 16px; cursor: pointer; transition: .15s ease; }
    .upload-area:hover { border-color: var(--primary); background: var(--hover); }
    .upload-area.dragover { border-color: var(--accent); background: rgba(123, 211, 137, 0.1); }
    
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted); }
    .form-group input, .form-group select { width: 100%; padding: 8px; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“š PDF å›¾ä¹¦é¦†</h1>
    <div class="search">
      <input id="search" type="search" placeholder="æœç´¢æ ‡é¢˜/æ–‡ä»¶å/è·¯å¾„/æ ‡ç­¾â€¦ (æŒ‰ / èšç„¦)" />
      <span class="count" id="count"></span>
    </div>
    <button class="btn" id="expandAll">å…¨éƒ¨å±•å¼€</button>
    <button class="btn" id="collapseAll">å…¨éƒ¨æŠ˜å </button>
  </header>
  <div class="layout">
    <aside>
      <div class="tree" id="tree"></div>
    </aside>
    <main>
      <div class="filters">
        <div class="chips" id="tagChips"></div>
        <button class="btn" id="toggleFav">ä»…çœ‹æ”¶è—</button>
        <button class="btn" id="openNative" disabled>åœ¨æµè§ˆå™¨æ‰“å¼€</button>
        <button class="btn" id="copyLink" disabled>å¤åˆ¶é“¾æ¥</button>
        <button class="btn" id="manageFiles">ğŸ“ æ–‡ä»¶ç®¡ç†</button>
        <span class="hint">å›è½¦æ‰“å¼€ï¼ŒF æ”¶è—/å–æ¶ˆï¼ŒEsc æ¸…ç©ºæœç´¢</span>
      </div>
      <div class="cards" id="cards"></div>
      <div class="related" id="related" style="display:none">
        <div>ğŸ“– ç›¸å…³ä¹¦ç±</div>
        <div class="rel-items" id="relItems"></div>
      </div>
    </main>
  </div>

  <!-- æ–‡ä»¶ç®¡ç†æ¨¡æ€æ¡† -->
  <div class="file-manager" id="fileManager">
    <div class="panel">
      <header>
        <h3>ğŸ“ æ–‡ä»¶ç®¡ç†</h3>
        <button class="btn" id="closeFileManager">âœ•</button>
      </header>
      <div class="content">
        <div class="form-group">
          <label>GitHub Token (éœ€è¦ repo æƒé™)</label>
          <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        </div>
        
        <div class="upload-area" id="uploadArea">
          <div>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">æ”¯æŒ PDF æ–‡ä»¶</div>
          <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
        </div>
        
        <div class="form-group">
          <label>ç›®æ ‡ç›®å½•</label>
          <select id="targetDir">
            <option value="">æ ¹ç›®å½• (pdfs/)</option>
          </select>
        </div>
        
        <div class="form-group">
          <button class="btn" id="createDir">ğŸ“ åˆ›å»ºæ–°ç›®å½•</button>
          <input type="text" id="newDirName" placeholder="ç›®å½•å" style="margin-left: 8px; width: 200px;">
        </div>
        
        <div class="file-list" id="fileList">
          <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="refreshFiles">ğŸ”„ åˆ·æ–°</button>
        <button class="btn" id="saveFileManager">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      items: [],
      filtered: [],
      treeRoot: {},
      selected: null,
      tagCounts: new Map(),
      activeTags: new Set(),
      onlyFav: false,
    };

    const elTree = document.getElementById('tree');
    const elCards = document.getElementById('cards');
    const elSearch = document.getElementById('search');
    const elCount = document.getElementById('count');
    const elTagChips = document.getElementById('tagChips');
    const elRelated = document.getElementById('related');
    const elRelItems = document.getElementById('relItems');
    const btnOpenNative = document.getElementById('openNative');
    const btnCopyLink = document.getElementById('copyLink');
    const btnManageFiles = document.getElementById('manageFiles');

    const LS_FAV = 'pdf:favorites';
    const LS_PROGRESS = 'pdf:progress';

    function loadFavs() { return new Set(JSON.parse(localStorage.getItem(LS_FAV) || '[]')); }
    function saveFavs(s) { localStorage.setItem(LS_FAV, JSON.stringify(Array.from(s))); }
    function loadProgress() { try { return JSON.parse(localStorage.getItem(LS_PROGRESS) || '{}'); } catch { return {}; } }
    function saveProgress(p) { localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

    let favs = loadFavs();
    let progress = loadProgress();

    function normalizeUrl(u) {
      if (!u) return u;
      if (u.startsWith('/pdfs/')) return u;
      if (u.startsWith('./pdfs/')) return u.replace('./pdfs/', '/pdfs/');
      if (u.startsWith('pdfs/')) return '/' + u;
      return u;
    }
    function normalizeCover(u) {
      if (!u) return u;
      if (u.startsWith('/covers/')) return u;
      if (u.startsWith('./covers/')) return u.replace('./covers/', '/covers/');
      if (u.startsWith('covers/')) return '/' + u;
      return u;
    }

    fetch('./meta.json?_=' + Date.now()).then(r => r.json()).then(meta => {
      let items = Array.isArray(meta.items) ? meta.items : [];
      items = items.map(it => ({ ...it, url: normalizeUrl(it.url), cover: normalizeCover(it.cover) }));
      state.items = items;
      const counts = new Map();
      for (const it of state.items) {
        const tags = Array.isArray(it.tags) ? it.tags : [];
        for (const t of tags) counts.set(t, (counts.get(t) || 0) + 1);
      }
      state.tagCounts = counts;
      buildTree();
      renderAll();
      restoreFromHash();
    }).catch(() => {
      state.items = [];
      buildTree();
      renderAll();
    });

    function pathSegments(p) { return p.split('/').filter(Boolean); }

    function buildTree() {
      const root = { name: '', children: new Map(), files: [] };
      for (const it of state.items) {
        const segs = pathSegments(it.path);
        let cur = root;
        for (let i = 0; i < segs.length - 1; i++) {
          const name = segs[i];
          if (!cur.children.has(name)) cur.children.set(name, { name, children: new Map(), files: [] });
          cur = cur.children.get(name);
        }
        cur.files.push(it);
      }
      state.treeRoot = root;
    }

    function detailsNode(node, prefix = '') {
      const entries = Array.from(node.children.keys()).sort();
      const files = node.files.slice().sort((a,b)=>a.name.localeCompare(b.name));
      let html = '';
      for (const dir of entries) {
        const child = node.children.get(dir);
        html += `<details open data-dir="${prefix + dir}"><summary>ğŸ“ ${dir}</summary>`;
        html += `<div class="group">${detailsNode(child, prefix + dir + '/')}</div>`;
        html += `</details>`;
      }
      for (const f of files) {
        html += `<a href="#${encodeURIComponent(f.path)}" data-file="${f.path}">ğŸ“„ ${f.name}</a>`;
      }
      return html;
    }

    function renderTree() {
      elTree.innerHTML = detailsNode(state.treeRoot);
      elTree.querySelectorAll('a[data-file]').forEach(a => {
        a.addEventListener('click', (e) => { e.preventDefault(); const p = a.getAttribute('data-file'); selectFile(p); });
      });
    }

    function matchesFilters(it) {
      const q = elSearch.value.trim().toLowerCase();
      if (q) {
        const hay = [it.title||'', it.name||'', it.displayPath||it.path||'', (it.tags||[]).join(' ')].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (state.activeTags.size) {
        const tset = new Set(it.tags || []);
        for (const t of state.activeTags) { if (!tset.has(t)) return false; }
      }
      if (state.onlyFav && !favs.has(it.path)) return false;
      return true;
    }

    function fullUrl(rel) { return location.origin + rel; }

    function renderCards() {
      const list = state.items.filter(matchesFilters);
      state.filtered = list;
      elCount.textContent = `${list.length} ä¸ªæ–‡ä»¶`;
      elCards.innerHTML = list.map(it => {
        const cov = it.cover ? it.cover : '';
        const covHtml = cov ? `<img loading=\"lazy\" src=\"${cov}\" alt=\"${it.name}\"/>` : `<span>æ— å°é¢</span>`;
        const fav = favs.has(it.path) ? 'active' : '';
        const pages = it.pages ? `${it.pages}é¡µ` : '';
        return `
          <div class=\"card\" data-file=\"${it.path}\" data-url=\"${it.url}\">
            <div class=\"openbtn\" title=\"åœ¨æµè§ˆå™¨æ‰“å¼€\" data-open=\"${it.url}\">â†—</div>
            <div class=\"fav ${fav}\" data-fav=\"${it.path}\">â˜…</div>
            <div class=\"thumb\">${covHtml}</div>
            <div class=\"meta\">
              <div class=\"name\">${it.title || it.name}</div>
              <div class=\"badges\"><span>${pages}</span></div>
              <div class=\"path\">${it.displayPath || it.path}</div>
            </div>
          </div>`;
      }).join('');
      elCards.querySelectorAll('.card').forEach(c => { c.addEventListener('click', (e) => { if (e.target && (e.target.matches('.fav') || e.target.matches('.openbtn'))) return; selectFile(c.getAttribute('data-file')); }); });
      elCards.querySelectorAll('.fav').forEach(f => { f.addEventListener('click', (e) => { const p = f.getAttribute('data-fav'); if (favs.has(p)) favs.delete(p); else favs.add(p); saveFavs(favs); renderCards(); }); });
      elCards.querySelectorAll('.openbtn').forEach(o => { o.addEventListener('click', (e) => { e.stopPropagation(); const u = o.getAttribute('data-open'); window.open(u, '_blank'); }); });
    }

    function similarScore(a, b) { const ta = new Set(a.tags || []); const tb = new Set(b.tags || []); let inter = 0; for (const t of ta) if (tb.has(t)) inter++; return inter; }

    function renderRelated(base) {
      const others = state.items.filter(x => x.path !== base.path);
      others.sort((x,y) => similarScore(y, base) - similarScore(x, base));
      const top = others.filter(x => similarScore(x, base) > 0).slice(0, 12);
      if (!top.length) { elRelated.style.display = 'none'; return; }
      elRelated.style.display = '';
      elRelItems.innerHTML = top.map(it => `<span class=\"rel-item\" data-file=\"${it.path}\">${it.title || it.name}</span>`).join('');
      elRelItems.querySelectorAll('.rel-item').forEach(n => n.addEventListener('click', () => selectFile(n.getAttribute('data-file'))));
    }

    function renderTagChips() {
      const entries = Array.from(state.tagCounts.entries()).sort((a,b)=> b[1]-a[1]).slice(0, 60);
      elTagChips.innerHTML = entries.map(([t,c]) => `<span class=\"chip ${state.activeTags.has(t)?'active':''}\" data-tag=\"${t}\">${t}<span>${c}</span></span>`).join('');
      elTagChips.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => { const t = ch.getAttribute('data-tag'); if (state.activeTags.has(t)) state.activeTags.delete(t); else state.activeTags.add(t); renderAll(); }));
    }

    function renderAll() { renderTagChips(); renderTree(); renderCards(); updateOpenButtons(); }

    function selectFile(path) {
      const item = state.items.find(x => x.path === path);
      if (!item) return;
      state.selected = item;
      window.open(item.url, '_blank');
      location.hash = encodeURIComponent(item.path);
      renderRelated(item);
      updateOpenButtons();
    }

    function updateOpenButtons() {
      const has = !!state.selected;
      btnOpenNative.disabled = !has;
      btnCopyLink.disabled = !has;
    }

    function restoreFromHash() { const h = location.hash.startsWith('#') ? decodeURIComponent(location.hash.slice(1)) : ''; if (h) selectFile(h); }

    window.addEventListener('hashchange', restoreFromHash);
    document.getElementById('expandAll').addEventListener('click', () => { elTree.querySelectorAll('details').forEach(d => d.open = true); });
    document.getElementById('collapseAll').addEventListener('click', () => { elTree.querySelectorAll('details').forEach(d => d.open = false); });
    document.getElementById('toggleFav').addEventListener('click', () => { state.onlyFav = !state.onlyFav; renderCards(); });
    elSearch.addEventListener('input', () => { renderCards(); });
    window.addEventListener('keydown', (e) => { if (e.key === '/') { e.preventDefault(); elSearch.focus(); return; } if (e.key === 'Escape') { elSearch.value=''; renderCards(); return; } });


    btnOpenNative.addEventListener('click', () => { if (!state.selected) return; window.open(state.selected.url, '_blank'); });
    btnCopyLink.addEventListener('click', async () => { if (!state.selected) return; const link = fullUrl(state.selected.url); try { await navigator.clipboard.writeText(link); btnCopyLink.textContent = 'å·²å¤åˆ¶'; setTimeout(()=>btnCopyLink.textContent='å¤åˆ¶é“¾æ¥', 1000); } catch { prompt('å¤åˆ¶å¤±è´¥ï¼Œæ‰‹åŠ¨å¤åˆ¶ï¼š', link); } });

    // æ–‡ä»¶ç®¡ç†åŠŸèƒ½
    const fileManager = document.getElementById('fileManager');
    const githubToken = document.getElementById('githubToken');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const targetDir = document.getElementById('targetDir');
    const newDirName = document.getElementById('newDirName');
    const fileList = document.getElementById('fileList');
    const createDirBtn = document.getElementById('createDir');
    const refreshFilesBtn = document.getElementById('refreshFiles');
    const saveFileManagerBtn = document.getElementById('saveFileManager');
    const closeFileManagerBtn = document.getElementById('closeFileManager');

    // GitHub API é…ç½®
    const GITHUB_OWNER = 'songtheme6';
    const GITHUB_REPO = 'songtheme6.github.io';
    const GITHUB_API_BASE = 'https://api.github.com';

    // ä» localStorage åŠ è½½ token
    const savedToken = localStorage.getItem('github_token');
    if (savedToken) {
      githubToken.value = savedToken;
    }

    // ä¿å­˜ token åˆ° localStorage
    githubToken.addEventListener('input', () => {
      localStorage.setItem('github_token', githubToken.value);
    });

    // æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
    btnManageFiles.addEventListener('click', () => {
      fileManager.style.display = 'flex';
      loadDirectories();
      loadFiles();
    });

    // å…³é—­æ–‡ä»¶ç®¡ç†å™¨
    closeFileManagerBtn.addEventListener('click', () => {
      fileManager.style.display = 'none';
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    fileManager.addEventListener('click', (e) => {
      if (e.target === fileManager) {
        fileManager.style.display = 'none';
      }
    });

    // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.pdf'));
      uploadFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      uploadFiles(files);
    });

    // åˆ›å»ºç›®å½•
    createDirBtn.addEventListener('click', async () => {
      const dirName = newDirName.value.trim();
      if (!dirName) {
        alert('è¯·è¾“å…¥ç›®å½•å');
        return;
      }
      await createDirectory(dirName);
      newDirName.value = '';
      loadDirectories();
    });

    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    refreshFilesBtn.addEventListener('click', () => {
      loadFiles();
    });

    // ä¿å­˜å¹¶è§¦å‘ Actions
    saveFileManagerBtn.addEventListener('click', async () => {
      await triggerActions();
      alert('å·²è§¦å‘ GitHub Actionsï¼Œè¯·ç­‰å¾…å‡ åˆ†é’Ÿååˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°');
    });

    // GitHub API å‡½æ•°
    async function githubRequest(endpoint, options = {}) {
      const token = githubToken.value;
      if (!token) {
        throw new Error('è¯·å…ˆè¾“å…¥ GitHub Token');
      }

      const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`GitHub API é”™è¯¯: ${response.status} - ${error}`);
      }

      return response.json();
    }

    // åŠ è½½ç›®å½•åˆ—è¡¨
    async function loadDirectories() {
      try {
        const contents = await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/pdfs`);
        const dirs = contents.filter(item => item.type === 'dir');
        
        targetDir.innerHTML = '<option value="">æ ¹ç›®å½• (pdfs/)</option>';
        dirs.forEach(dir => {
          const option = document.createElement('option');
          option.value = dir.name;
          option.textContent = `${dir.name}/`;
          targetDir.appendChild(option);
        });
      } catch (error) {
        console.error('åŠ è½½ç›®å½•å¤±è´¥:', error);
        alert('åŠ è½½ç›®å½•å¤±è´¥: ' + error.message);
      }
    }

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    async function loadFiles() {
      try {
        const contents = await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/pdfs`);
        const files = contents.filter(item => item.type === 'file' && item.name.endsWith('.pdf'));
        
        fileList.innerHTML = files.map(file => `
          <div class="file-item">
            <span class="icon">ğŸ“„</span>
            <span class="name">${file.name}</span>
            <span class="size">${(file.size / 1024).toFixed(1)} KB</span>
            <div class="actions">
              <button class="btn" onclick="deleteFile('${file.name}', '${file.sha}')">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
        alert('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
      }
    }

    // ä¸Šä¼ æ–‡ä»¶
    async function uploadFiles(files) {
      const token = githubToken.value;
      if (!token) {
        alert('è¯·å…ˆè¾“å…¥ GitHub Token');
        return;
      }

      const targetDirName = targetDir.value;
      const basePath = targetDirName ? `pdfs/${targetDirName}/` : 'pdfs/';

      for (const file of files) {
        try {
          const content = await fileToBase64(file);
          const path = `${basePath}${file.name}`;
          
          await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
            method: 'PUT',
            body: JSON.stringify({
              message: `Add ${file.name}`,
              content: content
            })
          });
          
          console.log(`ä¸Šä¼ æˆåŠŸ: ${file.name}`);
        } catch (error) {
          console.error(`ä¸Šä¼ å¤±è´¥ ${file.name}:`, error);
          alert(`ä¸Šä¼ å¤±è´¥ ${file.name}: ${error.message}`);
        }
      }
      
      loadFiles();
    }

    // åˆ é™¤æ–‡ä»¶
    window.deleteFile = async function(fileName, sha) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${fileName} å—ï¼Ÿ`)) return;
      
      try {
        await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/pdfs/${fileName}`, {
          method: 'DELETE',
          body: JSON.stringify({
            message: `Delete ${fileName}`,
            sha: sha
          })
        });
        
        loadFiles();
        alert('åˆ é™¤æˆåŠŸ');
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    };

    // åˆ›å»ºç›®å½•
    async function createDirectory(dirName) {
      const path = `pdfs/${dirName}/.gitkeep`;
      const content = btoa(''); // ç©ºæ–‡ä»¶
      
      try {
        await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
          method: 'PUT',
          body: JSON.stringify({
            message: `Create directory ${dirName}`,
            content: content
          })
        });
        
        alert('ç›®å½•åˆ›å»ºæˆåŠŸ');
      } catch (error) {
        console.error('åˆ›å»ºç›®å½•å¤±è´¥:', error);
        alert('åˆ›å»ºç›®å½•å¤±è´¥: ' + error.message);
      }
    }

    // è§¦å‘ GitHub Actions
    async function triggerActions() {
      try {
        // åˆ›å»ºä¸€ä¸ªç©ºæäº¤æ¥è§¦å‘ Actions
        const content = btoa(`# Trigger Actions\n${new Date().toISOString()}`);
        await githubRequest(`/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/.trigger`, {
          method: 'PUT',
          body: JSON.stringify({
            message: 'Trigger Actions',
            content: content
          })
        });
      } catch (error) {
        console.error('è§¦å‘ Actions å¤±è´¥:', error);
        alert('è§¦å‘ Actions å¤±è´¥: ' + error.message);
      }
    }

    // æ–‡ä»¶è½¬ Base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
