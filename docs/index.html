<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF 图书馆</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --panel-2: #0e1530;
      --text: #e6e9f5;
      --muted: #9aa3c7;
      --primary: #6aa3ff;
      --accent: #7bd389;
      --border: #223058;
      --card: #162246;
      --hover: #1c2b59;
      --danger: #ff7575;
      --warning: #ffcf66;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 14px/1.4 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #0f1733, #0b1020);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { font-size: 16px; margin: 0; letter-spacing: .5px; }
    header .search {
      flex: 1; display: flex; gap: 8px; align-items: center;
      background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px;
    }
    header input[type="search"] {
      flex: 1; background: transparent; border: none; outline: none; color: var(--text);
      font-size: 14px;
    }
    .layout { display: grid; grid-template-columns: 320px 1fr; height: calc(100% - 58px); }
    aside { border-right: 1px solid var(--border); background: var(--panel-2); overflow: auto; }
    main { display: grid; grid-template-rows: auto auto 1fr; }
    
    /* 手机适配 */
    @media (max-width: 768px) {
      .layout { grid-template-columns: 1fr; }
      aside { display: none; }
      header { flex-wrap: wrap; gap: 8px; }
      header .search { order: 2; width: 100%; }
      .filters { flex-wrap: wrap; gap: 6px; }
      .filters .hint { display: none; }
      .cards { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 8px; }
      .card .meta { padding: 6px; }
      .card .name { font-size: 12px; }
      .card .path { font-size: 11px; }
      .card .badges { font-size: 11px; }
      .related { padding: 6px 8px; }
      .rel-items { gap: 6px; }
      .rel-item { padding: 4px 6px; font-size: 12px; }
    }
    
    @media (max-width: 480px) {
      header { padding: 8px 12px; }
      header h1 { font-size: 14px; }
      .cards { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; padding: 6px; }
      .card .thumb { aspect-ratio: 2/3; }
      .filters { padding: 8px; }
      .btn { padding: 4px 8px; font-size: 12px; }
    }

    .filters { display: flex; gap: 8px; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); background: var(--panel-2); flex-wrap: wrap; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { padding: 4px 8px; border-radius: 999px; background: var(--card); border: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text); }
    .chip.active { background: #1f2b55; border-color: var(--primary); }
    .chip span { opacity: .7; margin-left: 4px; font-variant-numeric: tabular-nums; }

    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; padding: 12px; overflow: auto; background: var(--panel-2); border-bottom: 1px solid var(--border); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: .15s ease; position: relative; }
    .card:hover { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(106,163,255,.2) inset; }
    .thumb { aspect-ratio: 3/4; background: #0a0f22; display: grid; place-items: center; color: var(--muted); font-size: 12px; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; background: #000; }
    .meta { padding: 8px; display: grid; gap: 4px; }
    .name { font-size: 13px; line-height: 1.35; word-break: break-word; }
    .path { color: var(--muted); font-size: 12px; }
    .badges { display: flex; gap: 6px; align-items: center; color: var(--muted); font-size: 12px; }
    .fav { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.5); border: 1px solid var(--border); color: #ffd966; border-radius: 999px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .fav.active { background: #33280a; border-color: #ffcf66; }
    .openbtn { position: absolute; top: 6px; left: 6px; background: rgba(0,0,0,.5); border: 1px solid var(--border); color: #a4d0ff; border-radius: 999px; padding: 4px 8px; cursor: pointer; font-size: 12px; }

    .tree { padding: 8px 10px; }
    .tree details { border-radius: 8px; }
    .tree summary { cursor: pointer; padding: 6px 8px; border-radius: 8px; }
    .tree summary:hover { background: var(--hover); }
    .tree a { color: var(--text); text-decoration: none; display: block; padding: 6px 8px; border-radius: 8px; }
    .tree a:hover { background: var(--hover); }


    .toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 5; }
    .btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .btn:hover { border-color: var(--primary); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .hint { color: var(--muted); margin-left: auto; font-size: 12px; }

    .related { padding: 12px; border-top: 1px solid var(--border); background: #0f1733; color: var(--muted); font-size: 13px; }
    .rel-items { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .rel-item { background: var(--card); border: 1px solid var(--border); padding: 6px 8px; border-radius: 8px; cursor: pointer; transition: .15s ease; }
    .rel-item:hover { border-color: var(--primary); background: var(--hover); }

  </style>
</head>
<body>
  <header>
    <h1>📚 PDF 图书馆</h1>
    <div class="search">
      <input id="search" type="search" placeholder="搜索标题/文件名/路径/标签… (按 / 聚焦)" />
      <span class="count" id="count"></span>
    </div>
    <button class="btn" id="expandAll">全部展开</button>
    <button class="btn" id="collapseAll">全部折叠</button>
  </header>
  <div class="layout">
    <aside>
      <div class="tree" id="tree"></div>
    </aside>
    <main>
      <div class="filters">
        <div class="chips" id="tagChips"></div>
        <button class="btn" id="toggleFav">仅看收藏</button>
        <button class="btn" id="openNative" disabled>在浏览器打开</button>
        <button class="btn" id="copyLink" disabled>复制链接</button>
        <span class="hint">回车打开，F 收藏/取消，Esc 清空搜索</span>
      </div>
      <div class="cards" id="cards"></div>
      <div class="related" id="related" style="display:none">
        <div>📖 相关书籍</div>
        <div class="rel-items" id="relItems"></div>
      </div>
    </main>
  </div>


  <script>
    const state = {
      items: [],
      filtered: [],
      treeRoot: {},
      selected: null,
      tagCounts: new Map(),
      activeTags: new Set(),
      onlyFav: false,
    };

    const elTree = document.getElementById('tree');
    const elCards = document.getElementById('cards');
    const elSearch = document.getElementById('search');
    const elCount = document.getElementById('count');
    const elTagChips = document.getElementById('tagChips');
    const elRelated = document.getElementById('related');
    const elRelItems = document.getElementById('relItems');
    const btnOpenNative = document.getElementById('openNative');
    const btnCopyLink = document.getElementById('copyLink');

    const LS_FAV = 'pdf:favorites';
    const LS_PROGRESS = 'pdf:progress';

    function loadFavs() { return new Set(JSON.parse(localStorage.getItem(LS_FAV) || '[]')); }
    function saveFavs(s) { localStorage.setItem(LS_FAV, JSON.stringify(Array.from(s))); }
    function loadProgress() { try { return JSON.parse(localStorage.getItem(LS_PROGRESS) || '{}'); } catch { return {}; } }
    function saveProgress(p) { localStorage.setItem(LS_PROGRESS, JSON.stringify(p)); }

    let favs = loadFavs();
    let progress = loadProgress();

    function normalizeUrl(u) {
      if (!u) return u;
      if (u.startsWith('/pdfs/')) return u;
      if (u.startsWith('./pdfs/')) return u.replace('./pdfs/', '/pdfs/');
      if (u.startsWith('pdfs/')) return '/' + u;
      return u;
    }
    function normalizeCover(u) {
      if (!u) return u;
      if (u.startsWith('/covers/')) return u;
      if (u.startsWith('./covers/')) return u.replace('./covers/', '/covers/');
      if (u.startsWith('covers/')) return '/' + u;
      return u;
    }

    fetch('./meta.json?_=' + Date.now()).then(r => r.json()).then(meta => {
      let items = Array.isArray(meta.items) ? meta.items : [];
      items = items.map(it => ({ ...it, url: normalizeUrl(it.url), cover: normalizeCover(it.cover) }));
      state.items = items;
      const counts = new Map();
      for (const it of state.items) {
        const tags = Array.isArray(it.tags) ? it.tags : [];
        for (const t of tags) counts.set(t, (counts.get(t) || 0) + 1);
      }
      state.tagCounts = counts;
      buildTree();
      renderAll();
      restoreFromHash();
    }).catch(() => {
      state.items = [];
      buildTree();
      renderAll();
    });

    function pathSegments(p) { return p.split('/').filter(Boolean); }

    function buildTree() {
      const root = { name: '', children: new Map(), files: [] };
      for (const it of state.items) {
        const segs = pathSegments(it.path);
        let cur = root;
        for (let i = 0; i < segs.length - 1; i++) {
          const name = segs[i];
          if (!cur.children.has(name)) cur.children.set(name, { name, children: new Map(), files: [] });
          cur = cur.children.get(name);
        }
        cur.files.push(it);
      }
      state.treeRoot = root;
    }

    function detailsNode(node, prefix = '') {
      const entries = Array.from(node.children.keys()).sort();
      const files = node.files.slice().sort((a,b)=>a.name.localeCompare(b.name));
      let html = '';
      for (const dir of entries) {
        const child = node.children.get(dir);
        html += `<details open data-dir="${prefix + dir}"><summary>📁 ${dir}</summary>`;
        html += `<div class="group">${detailsNode(child, prefix + dir + '/')}</div>`;
        html += `</details>`;
      }
      for (const f of files) {
        html += `<a href="#${encodeURIComponent(f.path)}" data-file="${f.path}">📄 ${f.name}</a>`;
      }
      return html;
    }

    function renderTree() {
      elTree.innerHTML = detailsNode(state.treeRoot);
      elTree.querySelectorAll('a[data-file]').forEach(a => {
        a.addEventListener('click', (e) => { e.preventDefault(); const p = a.getAttribute('data-file'); selectFile(p); });
      });
    }

    function matchesFilters(it) {
      const q = elSearch.value.trim().toLowerCase();
      if (q) {
        const hay = [it.title||'', it.name||'', it.displayPath||it.path||'', (it.tags||[]).join(' ')].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (state.activeTags.size) {
        const tset = new Set(it.tags || []);
        for (const t of state.activeTags) { if (!tset.has(t)) return false; }
      }
      if (state.onlyFav && !favs.has(it.path)) return false;
      return true;
    }

    function fullUrl(rel) { return location.origin + rel; }

    function renderCards() {
      const list = state.items.filter(matchesFilters);
      state.filtered = list;
      elCount.textContent = `${list.length} 个文件`;
      elCards.innerHTML = list.map(it => {
        const cov = it.cover ? it.cover : '';
        const covHtml = cov ? `<img loading=\"lazy\" src=\"${cov}\" alt=\"${it.name}\"/>` : `<span>无封面</span>`;
        const fav = favs.has(it.path) ? 'active' : '';
        const pages = it.pages ? `${it.pages}页` : '';
        return `
          <div class=\"card\" data-file=\"${it.path}\" data-url=\"${it.url}\">
            <div class=\"openbtn\" title=\"在浏览器打开\" data-open=\"${it.url}\">↗</div>
            <div class=\"fav ${fav}\" data-fav=\"${it.path}\">★</div>
            <div class=\"thumb\">${covHtml}</div>
            <div class=\"meta\">
              <div class=\"name\">${it.title || it.name}</div>
              <div class=\"badges\"><span>${pages}</span></div>
              <div class=\"path\">${it.displayPath || it.path}</div>
            </div>
          </div>`;
      }).join('');
      elCards.querySelectorAll('.card').forEach(c => { c.addEventListener('click', (e) => { if (e.target && (e.target.matches('.fav') || e.target.matches('.openbtn'))) return; selectFile(c.getAttribute('data-file')); }); });
      elCards.querySelectorAll('.fav').forEach(f => { f.addEventListener('click', (e) => { const p = f.getAttribute('data-fav'); if (favs.has(p)) favs.delete(p); else favs.add(p); saveFavs(favs); renderCards(); }); });
      elCards.querySelectorAll('.openbtn').forEach(o => { o.addEventListener('click', (e) => { e.stopPropagation(); const u = o.getAttribute('data-open'); window.open(u, '_blank'); }); });
    }

    function similarScore(a, b) { const ta = new Set(a.tags || []); const tb = new Set(b.tags || []); let inter = 0; for (const t of ta) if (tb.has(t)) inter++; return inter; }

    function renderRelated(base) {
      const others = state.items.filter(x => x.path !== base.path);
      others.sort((x,y) => similarScore(y, base) - similarScore(x, base));
      const top = others.filter(x => similarScore(x, base) > 0).slice(0, 12);
      if (!top.length) { elRelated.style.display = 'none'; return; }
      elRelated.style.display = '';
      elRelItems.innerHTML = top.map(it => `<span class=\"rel-item\" data-file=\"${it.path}\">${it.title || it.name}</span>`).join('');
      elRelItems.querySelectorAll('.rel-item').forEach(n => n.addEventListener('click', () => selectFile(n.getAttribute('data-file'))));
    }

    function renderTagChips() {
      const entries = Array.from(state.tagCounts.entries()).sort((a,b)=> b[1]-a[1]).slice(0, 60);
      elTagChips.innerHTML = entries.map(([t,c]) => `<span class=\"chip ${state.activeTags.has(t)?'active':''}\" data-tag=\"${t}\">${t}<span>${c}</span></span>`).join('');
      elTagChips.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => { const t = ch.getAttribute('data-tag'); if (state.activeTags.has(t)) state.activeTags.delete(t); else state.activeTags.add(t); renderAll(); }));
    }

    function renderAll() { renderTagChips(); renderTree(); renderCards(); updateOpenButtons(); }

    function selectFile(path) {
      const item = state.items.find(x => x.path === path);
      if (!item) return;
      state.selected = item;
      window.open(item.url, '_blank');
      location.hash = encodeURIComponent(item.path);
      renderRelated(item);
      updateOpenButtons();
    }

    function updateOpenButtons() {
      const has = !!state.selected;
      btnOpenNative.disabled = !has;
      btnCopyLink.disabled = !has;
    }

    function restoreFromHash() { const h = location.hash.startsWith('#') ? decodeURIComponent(location.hash.slice(1)) : ''; if (h) selectFile(h); }

    window.addEventListener('hashchange', restoreFromHash);
    document.getElementById('expandAll').addEventListener('click', () => { elTree.querySelectorAll('details').forEach(d => d.open = true); });
    document.getElementById('collapseAll').addEventListener('click', () => { elTree.querySelectorAll('details').forEach(d => d.open = false); });
    document.getElementById('toggleFav').addEventListener('click', () => { state.onlyFav = !state.onlyFav; renderCards(); });
    elSearch.addEventListener('input', () => { renderCards(); });
    window.addEventListener('keydown', (e) => { if (e.key === '/') { e.preventDefault(); elSearch.focus(); return; } if (e.key === 'Escape') { elSearch.value=''; renderCards(); return; } });


    btnOpenNative.addEventListener('click', () => { if (!state.selected) return; window.open(state.selected.url, '_blank'); });
    btnCopyLink.addEventListener('click', async () => { if (!state.selected) return; const link = fullUrl(state.selected.url); try { await navigator.clipboard.writeText(link); btnCopyLink.textContent = '已复制'; setTimeout(()=>btnCopyLink.textContent='复制链接', 1000); } catch { prompt('复制失败，手动复制：', link); } });
  </script>
</body>
</html>
